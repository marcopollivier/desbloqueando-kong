_format_version: "3.0"
_transform: true

# Upstream configuration
upstreams:
  - name: api-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    hash_on_cookie_path: /
    slots: 10000
    healthchecks:
      active:
        https_verify_certificate: true
        unhealthy:
          interval: 0
          http_statuses: [429, 404, 500, 501, 502, 503, 504, 505]
          tcp_failures: 0
          timeouts: 0
        healthy:
          interval: 30
          http_statuses: [200, 302]
          successes: 0
        http_path: /health
        timeout: 1
        concurrency: 10
        type: http
      passive:
        unhealthy:
          http_failures: 0
          http_statuses: [429, 500, 503]
          tcp_failures: 0
          timeouts: 0
        healthy:
          http_statuses: [200, 201, 202, 203, 204, 205, 206, 207, 208, 226, 300, 301, 302, 303, 304, 305, 306, 307, 308]
          successes: 0
      threshold: 0

# Targets for the upstream
targets:
  - target: go-mock-api-1:3001
    upstream: api-upstream
    weight: 100
  - target: node-mock-api-2:3002
    upstream: api-upstream  
    weight: 100

# Service using the upstream
services:
  - name: load-balanced-api
    host: api-upstream
    port: 80
    protocol: http
    path: /
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    retries: 5

# Routes
routes:
  - name: lb-route
    service: load-balanced-api
    protocols: [http, https]
    methods: [GET, POST, PUT, PATCH, DELETE]
    paths: [/api]
    strip_path: true
    preserve_host: false
